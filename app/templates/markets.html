{% extends "base.html" %} {% block title %}Markets - Agri Bantay Presyo{%
endblock %} {% block content %}
<!-- Price Ticker -->
<div class="border-b border-border/50 bg-card/50 py-3 overflow-hidden">
  <div class="ticker-scroll flex gap-8 whitespace-nowrap">
    {% for item in ticker_items %}
    <div class="flex items-center gap-2 px-4">
      <span class="font-bold">{{ item.name }}</span>
      <span class="text-primary font-black"
        >₱{{ "%.2f"|format(item.price) }}</span
      >
      {% if item.change >= 0 %}
      <span class="text-emerald-500 text-sm"
        >▲ {{ "%.1f"|format(item.change) }}%</span
      >
      {% else %}
      <span class="text-red-500 text-sm"
        >▼ {{ "%.1f"|format(item.change|abs) }}%</span
      >
      {% endif %}
    </div>
    {% endfor %} {% for item in ticker_items %}
    <div class="flex items-center gap-2 px-4">
      <span class="font-bold">{{ item.name }}</span>
      <span class="text-primary font-black"
        >₱{{ "%.2f"|format(item.price) }}</span
      >
      {% if item.change >= 0 %}
      <span class="text-emerald-500 text-sm"
        >▲ {{ "%.1f"|format(item.change) }}%</span
      >
      {% else %}
      <span class="text-red-500 text-sm"
        >▼ {{ "%.1f"|format(item.change|abs) }}%</span
      >
      {% endif %}
    </div>
    {% endfor %}
  </div>
</div>

<div class="container mx-auto px-4 py-8 space-y-8" x-data="marketHub()">
  <!-- Header -->
  <header class="flex flex-col md:flex-row md:items-end justify-between gap-6">
    <div class="space-y-2">
      <div
        class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-primary/10 text-primary text-[10px] font-black uppercase tracking-widest border border-primary/20"
      >
        <i data-lucide="database" class="size-3"></i>
        Live Repository
      </div>
      <h1 class="text-4xl font-black tracking-tighter">
        Market <span class="text-primary italic">Hub</span>
      </h1>
      <p class="text-muted font-bold max-w-xl">
        Filter through thousands of price entries collected from major trading
        centers across the Philippines.
      </p>
    </div>

    <!-- Filters -->
    <div class="flex flex-wrap items-center gap-3">
      <div class="relative">
        <i
          data-lucide="search"
          class="absolute left-3 top-1/2 -translate-y-1/2 size-4 text-muted pointer-events-none"
        ></i>
        <input
          type="text"
          placeholder="Search commodities..."
          x-model="searchQuery"
          @input="currentPage = 1"
          class="h-11 pl-10 pr-4 rounded-xl border border-border bg-background font-bold text-sm focus:outline-none focus:ring-2 focus:ring-primary/20 w-full md:w-64"
        />
      </div>

      <select
        x-model="selectedCategory"
        @change="currentPage = 1"
        class="h-11 px-4 rounded-xl border border-border bg-background font-bold text-sm focus:outline-none focus:ring-2 focus:ring-primary/20"
      >
        <option value="all">All Categories</option>
        {% for cat in categories %}
        <option value="{{ cat }}">{{ cat }}</option>
        {% endfor %}
      </select>

      <select
        x-model="selectedMarket"
        @change="currentPage = 1"
        class="h-11 px-4 rounded-xl border border-border bg-background font-bold text-sm focus:outline-none focus:ring-2 focus:ring-primary/20"
      >
        <option value="all">All Markets</option>
        {% for market in markets %}
        <option value="{{ market.id }}">{{ market.name }}</option>
        {% endfor %}
      </select>

      <select
        x-model="selectedRegion"
        @change="currentPage = 1"
        class="h-11 px-4 rounded-xl border border-border bg-background font-bold text-sm focus:outline-none focus:ring-2 focus:ring-primary/20"
      >
        <option value="all">All Regions</option>
        {% for region in regions %}
        <option value="{{ region }}">{{ region }}</option>
        {% endfor %}
      </select>

      <div class="flex items-center gap-2">
        <input
          type="date"
          x-model="dateFrom"
          @change="currentPage = 1"
          class="h-11 px-4 rounded-xl border border-border bg-background font-bold text-sm focus:outline-none focus:ring-2 focus:ring-primary/20"
        />
        <span class="text-muted text-sm">to</span>
        <input
          type="date"
          x-model="dateTo"
          @change="currentPage = 1"
          class="h-11 px-4 rounded-xl border border-border bg-background font-bold text-sm focus:outline-none focus:ring-2 focus:ring-primary/20"
        />
      </div>

      <a
        href="/api/v1/prices/export"
        class="h-11 px-4 rounded-xl border border-border bg-background font-bold text-sm hover:bg-card transition-colors flex items-center gap-2"
      >
        <i data-lucide="download" class="size-4"></i>
        Export CSV
      </a>
    </div>
  </header>

  <!-- Data Table -->
  <div class="glass-card rounded-2xl ring-1 ring-white/10 overflow-hidden">
    <div class="overflow-x-auto">
      <table class="w-full">
        <thead>
          <tr class="border-b border-border/50 bg-card/50">
            <th
              class="text-left py-4 px-6 text-xs font-black uppercase tracking-widest text-muted"
            >
              Commodity
            </th>
            <th
              class="text-left py-4 px-6 text-xs font-black uppercase tracking-widest text-muted"
            >
              Category
            </th>
            <th
              class="text-left py-4 px-6 text-xs font-black uppercase tracking-widest text-muted"
            >
              Market
            </th>
            <th
              class="text-right py-4 px-6 text-xs font-black uppercase tracking-widest text-muted"
            >
              Low
            </th>
            <th
              class="text-right py-4 px-6 text-xs font-black uppercase tracking-widest text-muted"
            >
              High
            </th>
            <th
              class="text-right py-4 px-6 text-xs font-black uppercase tracking-widest text-muted"
            >
              Prevailing
            </th>
            <th
              class="text-right py-4 px-6 text-xs font-black uppercase tracking-widest text-muted"
            >
              Date
            </th>
          </tr>
        </thead>
        <tbody>
          <template x-for="price in paginatedPrices" :key="price.id">
            <tr
              class="border-b border-border/30 hover:bg-card/50 transition-colors"
            >
              <td class="py-4 px-6">
                <div class="flex items-center gap-3">
                  <div
                    class="size-10 rounded-xl flex items-center justify-center flex-shrink-0"
                    :class="getCategoryStyle(price.category).bg"
                  >
                    <i :data-lucide="getCategoryIcon(price.category)" class="size-5" :class="getCategoryStyle(price.category).text"></i>
                  </div>
                  <span class="font-bold" x-text="price.commodity_name"></span>
                </div>
              </td>
              <td class="py-4 px-6">
                <span
                  class="px-3 py-1 rounded-full text-xs font-bold"
                  :class="getCategoryStyle(price.category).badge"
                  x-text="price.category"
                ></span>
              </td>
              <td
                class="py-4 px-6 text-muted font-bold"
                x-text="price.market_name"
              ></td>
              <td
                class="py-4 px-6 text-right font-bold text-muted"
                x-text="'₱' + (price.price_low || '-').toLocaleString()"
              ></td>
              <td
                class="py-4 px-6 text-right font-bold text-muted"
                x-text="'₱' + (price.price_high || '-').toLocaleString()"
              ></td>
              <td class="py-4 px-6 text-right">
                <span
                  class="font-black text-primary text-lg"
                  x-text="'₱' + (price.price_prevailing || price.price_average || 0).toFixed(2)"
                ></span>
              </td>
              <td
                class="py-4 px-6 text-right text-muted text-sm font-bold"
                x-text="formatDate(price.report_date)"
              ></td>
            </tr>
          </template>
        </tbody>
      </table>
    </div>

    <!-- Empty State -->
    <div x-show="filteredPrices.length === 0" class="py-16 text-center">
      <div
        class="size-16 rounded-2xl bg-muted/10 flex items-center justify-center mx-auto mb-4"
      >
        <i data-lucide="search-x" class="size-8 text-muted"></i>
      </div>
      <h3 class="font-bold text-lg">No results found</h3>
      <p class="text-muted text-sm mt-1">
        Try adjusting your filters or search query.
      </p>
    </div>

    <!-- Pagination -->
    <div
      class="flex flex-col md:flex-row items-center justify-between px-6 py-4 border-t border-border/30 gap-4"
    >
      <p class="text-sm text-muted font-bold">
        Showing <span x-text="paginationStart + 1"></span> to <span x-text="Math.min(paginationEnd, filteredPrices.length)"></span> of
        <span x-text="filteredPrices.length"></span> entries
      </p>
      
      <div class="flex items-center gap-2">
        <!-- Items per page -->
        <select
          x-model="perPage"
          @change="currentPage = 1"
          class="h-9 px-3 rounded-lg border border-border bg-background font-bold text-sm focus:outline-none focus:ring-2 focus:ring-primary/20"
        >
          <option value="10">10 / page</option>
          <option value="25">25 / page</option>
          <option value="50">50 / page</option>
          <option value="100">100 / page</option>
        </select>
        
        <!-- Page navigation -->
        <div class="flex items-center gap-1">
          <button
            @click="currentPage = 1"
            :disabled="currentPage === 1"
            class="size-9 rounded-lg border border-border bg-background hover:bg-card disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center transition-colors"
          >
            <i data-lucide="chevrons-left" class="size-4"></i>
          </button>
          <button
            @click="currentPage--"
            :disabled="currentPage === 1"
            class="size-9 rounded-lg border border-border bg-background hover:bg-card disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center transition-colors"
          >
            <i data-lucide="chevron-left" class="size-4"></i>
          </button>
          
          <template x-for="page in visiblePages" :key="page">
            <button
              @click="page !== '...' && (currentPage = page)"
              :class="page === currentPage ? 'bg-primary text-white border-primary' : 'bg-background hover:bg-card border-border'"
              :disabled="page === '...'"
              class="size-9 rounded-lg border font-bold text-sm flex items-center justify-center transition-colors"
              x-text="page"
            ></button>
          </template>
          
          <button
            @click="currentPage++"
            :disabled="currentPage === totalPages"
            class="size-9 rounded-lg border border-border bg-background hover:bg-card disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center transition-colors"
          >
            <i data-lucide="chevron-right" class="size-4"></i>
          </button>
          <button
            @click="currentPage = totalPages"
            :disabled="currentPage === totalPages"
            class="size-9 rounded-lg border border-border bg-background hover:bg-card disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center transition-colors"
          >
            <i data-lucide="chevrons-right" class="size-4"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  function marketHub() {
      return {
          prices: {{ prices_json|safe }},
          searchQuery: '{{ search_query }}' || '',
          selectedCategory: 'all',
          selectedMarket: 'all',
          selectedRegion: 'all',
          dateFrom: '',
          dateTo: '',
          currentPage: 1,
          perPage: 25,

          get filteredPrices() {
              return this.prices.filter(p => {
                  const matchesSearch = !this.searchQuery ||
                      p.commodity_name.toLowerCase().includes(this.searchQuery.toLowerCase());
                  const matchesCategory = this.selectedCategory === 'all' ||
                      p.category === this.selectedCategory;
                  const matchesMarket = this.selectedMarket === 'all' ||
                      p.market_id === this.selectedMarket;
                  const matchesRegion = this.selectedRegion === 'all' ||
                      p.market_region === this.selectedRegion;

                  let matchesDate = true;
                  if (p.report_date) {
                      const priceDate = new Date(p.report_date);
                      if (this.dateFrom) {
                          matchesDate = matchesDate && priceDate >= new Date(this.dateFrom);
                      }
                      if (this.dateTo) {
                          matchesDate = matchesDate && priceDate <= new Date(this.dateTo);
                      }
                  }

                  return matchesSearch && matchesCategory && matchesMarket && matchesRegion && matchesDate;
              });
          },

          get totalPages() {
              return Math.ceil(this.filteredPrices.length / this.perPage) || 1;
          },

          get paginationStart() {
              return (this.currentPage - 1) * this.perPage;
          },

          get paginationEnd() {
              return this.paginationStart + parseInt(this.perPage);
          },

          get paginatedPrices() {
              return this.filteredPrices.slice(this.paginationStart, this.paginationEnd);
          },

          get visiblePages() {
              const pages = [];
              const total = this.totalPages;
              const current = this.currentPage;
              
              if (total <= 7) {
                  for (let i = 1; i <= total; i++) pages.push(i);
              } else {
                  if (current <= 3) {
                      pages.push(1, 2, 3, 4, '...', total);
                  } else if (current >= total - 2) {
                      pages.push(1, '...', total - 3, total - 2, total - 1, total);
                  } else {
                      pages.push(1, '...', current - 1, current, current + 1, '...', total);
                  }
              }
              return pages;
          },

          formatDate(dateStr) {
              if (!dateStr) return '-';
              const date = new Date(dateStr);
              return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
          },

          getCategoryIcon(category) {
              const icons = {
                  'Rice': 'wheat',
                  'Corn': 'wheat',
                  'Fish': 'fish',
                  'Meat': 'beef',
                  'Poultry': 'egg',
                  'Vegetables': 'carrot',
                  'Fruits': 'apple',
                  'Spices': 'flame',
                  'Other': 'package',
                  'Highland Vegetables': 'mountain',
                  'Lowland Vegetables': 'leaf'
              };
              return icons[category] || 'circle';
          },

          getCategoryStyle(category) {
              const styles = {
                  'Rice': { bg: 'bg-amber-500/10', text: 'text-amber-500', badge: 'bg-amber-500/10 text-amber-500' },
                  'Corn': { bg: 'bg-yellow-500/10', text: 'text-yellow-500', badge: 'bg-yellow-500/10 text-yellow-500' },
                  'Fish': { bg: 'bg-blue-500/10', text: 'text-blue-500', badge: 'bg-blue-500/10 text-blue-500' },
                  'Meat': { bg: 'bg-red-500/10', text: 'text-red-500', badge: 'bg-red-500/10 text-red-500' },
                  'Poultry': { bg: 'bg-orange-500/10', text: 'text-orange-500', badge: 'bg-orange-500/10 text-orange-500' },
                  'Vegetables': { bg: 'bg-green-500/10', text: 'text-green-500', badge: 'bg-green-500/10 text-green-500' },
                  'Fruits': { bg: 'bg-pink-500/10', text: 'text-pink-500', badge: 'bg-pink-500/10 text-pink-500' },
                  'Spices': { bg: 'bg-rose-500/10', text: 'text-rose-500', badge: 'bg-rose-500/10 text-rose-500' },
                  'Other': { bg: 'bg-slate-500/10', text: 'text-slate-500', badge: 'bg-slate-500/10 text-slate-500' },
                  'Highland Vegetables': { bg: 'bg-emerald-500/10', text: 'text-emerald-500', badge: 'bg-emerald-500/10 text-emerald-500' },
                  'Lowland Vegetables': { bg: 'bg-lime-500/10', text: 'text-lime-500', badge: 'bg-lime-500/10 text-lime-500' }
              };
              return styles[category] || { bg: 'bg-primary/10', text: 'text-primary', badge: 'bg-primary/10 text-primary' };
          }
      }
  }

  // Re-initialize Lucide icons after Alpine renders
  document.addEventListener('alpine:initialized', () => {
      setTimeout(() => lucide.createIcons(), 100);
  });
  
  // Also re-initialize when data changes
  setInterval(() => lucide.createIcons(), 500);
  
  lucide.createIcons();
</script>
{% endblock %}
